<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>索问</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../css/mui.min.css">
		<style>
			html,body {
				background-color: #efeff4;
			}
			.title{
				margin: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
			}
		</style>
		<style>
			/*跨webview需要手动指定位置*/
			
			
			#receiptPopover {
				position: fixed;
				top: 16px;
				right: 6px;
			}
			#receiptPopover .mui-popover-arrow {
				left: auto;
				right: 6px;
			}
			p {
				text-indent: 22px;
			}
			span.mui-icon {
				font-size: 14px;
				color: #007aff;
				margin-left: -15px;
				padding-right: 10px;
			}
			
			/* 如下大小为三行popover弹出 菜单大小，可以根据实际大小调整 */
			.mui-popover {
				height: 150px;
				width: 200px;
			}
			
		</style>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/Long.min.js"></script>
	<script src="../../js/ByteBufferAB.min.js"></script>
	<script src="../../js/ProtoBuf.noparse.min.js"></script>
	<script src="../../js/Suowen.js"></script>	
	<script type="text/javascript" charset="utf-8">
      	mui.init({
				swipeBack: true //启用右滑关闭功能
			});
    </script>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav ">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<!--
            	作者：49264664@qq.com
            	时间：2015-07-02
            	描述：下列<a>中的href中的#XX 要和弹出菜单<div>中的id一致，这样才会出效果。
            -->
			<a class="mui-icon mui-icon-bars mui-pull-right" href="#receiptPopover"></a>
			<h1 class="mui-title">收货</h1>
		</header>
		<div class="mui-content">
			<h5>收货日期<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
			 	<button id='pickDateBtn' type="button" style="width: 100%; height: auto;">请选择日期</button>
			</div>
			<h5>送货商品<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
			 	<button class="mui-action-menu" id='selectPartner' type="button" style="width: 100%; height: auto;">请选择送货商...</button>
				<input id="partnerId" name="style" type="hidden" checked="" value="menu-move">
			</div>
			<h5>添加商品<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
			 	<button class="mui-action-menu" id='addGoodsBtn' type="button" style="width: 100%; height: auto;">添加商品...</button>
				<input id="goodsId" name="style" type="hidden" checked="" value="menu-move">
			</div>
			<h5>收货来源<font color="#FF0000" size="4">*</font>：</h5>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<span>退货</span>
					<div id="goodsRejected" class="mui-switch mui-active">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span>内部调拨</span>
					<div id="internalAllocation" class="mui-switch">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
			</ul>
				
			<p align="center">
				<a id="picture-btn" class="mui-btn mui-btn-primary mui-btn-block mui-btn-outlined" style="align-content: center; width: 95%; padding: 3px 20px;"><font size="3">选择凭证图片</font></a>
			</p>
				
			<div class="mui-card">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">商品1</a>
						<div class="mui-collapse-content">
							<form class="mui-input-group">
								<div class="mui-input-row">
									<label>单价</label>
									<input type="text" class="mui-input-clear" placeholder="单价">
								</div>
								<div class="mui-input-row">
									<label>数量</label>
									<input type="text" class="mui-input-clear" placeholder="数量">
								</div>
								<div class="mui-input-row">
									<label>总金额</label>
									<input type="text" class="mui-input-clear" placeholder="总金额">
								</div>
								
							</form>
						</div>
					</li>
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">商品2</a>
						<div class="mui-collapse-content">
							<form class="mui-input-group">
								<div class="mui-input-row">
									<label>单价</label>
									<input type="text" class="mui-input-clear" placeholder="单价">
								</div>
								<div class="mui-input-row">
									<label>数量</label>
									<input type="text" class="mui-input-clear" placeholder="数量">
								</div>
								<div class="mui-input-row">
									<label>总金额</label>
									<input type="text" class="mui-input-clear" placeholder="总金额">
								</div>
								
							</form>
						</div>
					</li>
				</ul>
			</div>
			<ul class="mui-table-view">
				
				<div class="mui-input-row">
					<label>总金额</label>
					<input id="totalAmount" type="text" class="mui-input-clear" placeholder="元">
				</div>
			</ul>
				
			
			<div class="mui-button-row" style="height: auto;">
				<button id="receiptConfirmBtn" type="button" style="width: 95%; height: auto;" class="mui-btn mui-btn-primary mui-btn-blue" onclick="return false;"><font size="3">提交收货单</font></button>
			</div>
		</div>
		
		<!--右上角弹出菜单-->
		<div id="receiptPopover" class="mui-popover">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<a href="receipt_list.html">收货单列表</a>
						</li>
						<li class="mui-table-view-cell">
							<a href="receipt_list.html">收到退货单列表</a>
						</li>
						<li class="mui-table-view-cell">
							<a href="receipt_list.html">内部调拨收货列表</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</body>
	<script>
		var aniShow = "pop-in";
		//只有ios支持的功能需要在Android平台隐藏；
		if (mui.os.android) {
			var list = document.querySelectorAll('.ios-only');
			if (list) {
				for (var i = 0; i < list.length; i++) {
					list[i].style.display = 'none';
				}
			}
			//Android平台暂时使用slide-in-right动画
			aniShow = "slide-in-right"
		}
	</script>
	<script>
		///////////////////////提交图片处理函数
		document.getElementById("picture-btn").addEventListener('tap',function () {
			var btnArray = [{title:"拍照或录像"},{title:"选取现有的"}];
			plus.nativeUI.actionSheet( {
				title:"选择照片",
				cancel:"取消",
				buttons:btnArray
			}, function(e){
				var index = e.index;
				var text = "你刚点击了\"";
				switch (index){
					case 0:
						text += "取消";
						break;
					case 1:
						text += "拍照或录像";
						break;
					case 2:
						text += "选取现有的";
						break;
				}
				//info.innerHTML = text+"\"按钮";
				console.log(text+"\"按钮");
			} );
		});
		///////////////////////提交图片处理函数
		
	</script>
	<script>
		///////////////////////开关按钮的事件处理函数
		mui('.mui-content .mui-switch').each(function() { //循环所有toggle
			//toggle.classList.contains('mui-active') 可识别该toggle的开关状态
			//this.parentNode.querySelector('span').innerText = '状态：' + (this.classList.contains('mui-active') ? 'true' : 'false');
			this.addEventListener('toggle', function(event) {
				//event.detail.isActive 可直接获取当前状态
				this.parentNode.querySelector('span').innerText = '状态：' + (event.detail.isActive ? 'true' : 'false');
			});
		});
		///////////////////////开关按钮的事件处理函数
		
		
		///////////////////////popover菜单的事件处理函数
		mui('.mui-scroll-wrapper').scroll();
		
		//下列的shown 和 hidden 会随菜单的开和关自动触发
		mui('body').on('shown', '.mui-popover', function(e) {
			console.log('shown', e.detail.id);//detail为当前popover元素
		});
		mui('body').on('hidden', '.mui-popover', function(e) {
			console.log('hidden', e.detail.id);//detail为当前popover元素
		});
		mui(".mui-navigate-right").on('tap', 'a', function() {
			console.log("click in mui navigate right "+this.innerText);
		});
		mui("#receiptPopover").on('tap', 'a', function() {
			console.log(this.innerText);
			var id = this.getAttribute('href');

			mui.openWindow({
				id: id,
				url: this.href,
				show: {
					aniShow: aniShow
				},
				styles:{
					popGesture: "close"
				},
				waiting: {
					autoShow:true,//自动显示等待框，默认为true
					title:'正在加载...',//等待对话框上显示的提示内容
				}
			});
			//传入toggle参数，用户也无需关心当前是显示还是隐藏状态，mui会自动识别处理；
			mui('.mui-popover').popover('toggle');
		});
		///////////////////////popover菜单的事件处理函数
	</script>
	<script type="text/javascript" charset="utf-8">
	//初始化API
    suowen.api.Init("http://suowen.tiger.mopaas.com");
    //添加协议文件
    suowen.api.AddProto("/partner/PartnerQuery.json");
    suowen.api.AddProto("/stock/ReceivingNoteForm.json");
    //编译api成JS调用对象
    var root = suowen.api.Build();
	
	var partnerQueryRequest = new root.partner.PartnerQueryRequest();
	var receivingNoteFormRequest = new root.stock.ReceivingNoteFormRequest();
			/*
			 //mui初始化
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			*/
			var d = new Date();
			var pickDateBtn = document.getElementById("pickDateBtn");
			pickDateBtn.innerText = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
				
			document.getElementById("pickDateBtn").addEventListener('tap', function() {
				var dDate = new Date();	// 现在的时间
				dDate.setFullYear(dDate.getFullYear(), dDate.getMonth(), dDate.getDate());
				var minDate = new Date();
				minDate.setFullYear(2010, 1, 1);
				var maxDate = new Date();
				maxDate.setFullYear(2017, 11, 31);
				plus.nativeUI.pickDate(function(e) {
					var d = e.date;
					dayVal = d.getMonth()+1;
					pickDateBtn.innerText = d.getFullYear() + "-" + dayVal + "-" + d.getDate();
				}, function(e) {
					//pickDateBtn.innerText = "您没有选择日期";
				}, {
					title: "请选择收货日期",
					date: dDate,
					minDate: minDate,
					maxDate: maxDate
				});
			});
		</script>

<script>
			var main,menu, mask = mui.createMask(_closeMenu);
			var showMenu = false,
				mode = 'menu-move';

			 //整体滑动暂不支持android手机，因为两个页面的移动动画，无法保证同步性；
			if (!mui.os.android) {
				//整体滑动暂不支持android手机，因为两个页面的移动动画，无法保证同步性；
				//document.getElementById("move-togger").classList.remove('mui-hidden');
				var spans = document.querySelectorAll('.android-only');
				for (var i=0,len=spans.length;i<len;i++) {
					spans[i].style.display = "none";
				}
			}

			mui.init({
				swipeBack: false,
				beforeback: back
			});

			function back() {
					if (showMenu) {
						//菜单处于显示状态，返回键应该先关闭菜单,阻止主窗口执行mui.back逻辑；
						closeMenu();
						return false;
					} else {
						//菜单处于隐藏状态，执行返回时，要先close菜单页面，然后继续执行mui.back逻辑关闭主窗口；
						menu.close('none');
						return true;
					}
				}
			//plusReady事件后，自动创建menu窗口；
			mui.plusReady(function() {
				
				var tokenVal = plus.storage.getItem("token_val");
				
				console.log(tokenVal);
				
				// 所有页面的fetch之前都要加上以下这句话，这个token值需要存起来。保存在本地。vvvv
		        suowen.api.token = tokenVal;
		        // 所有页面的fetch之前都要加上以下这句话，这个token值需要存起来。保存在本地。^^^^
		        //partnerQueryRequest.setMobile("15910816978");
		        var ulToShowHtml = "";
		        suowen.api.Fetch(partnerQueryRequest, function(response){
		        	var partner = response.getPartner();
		            //console.log(JSON.stringify(partner));
		            //var result = [];
		            
		            for(var i=0;i<partner.length;i++){
		            	//var e = partner[i].getId();
		        		//result[i] = {};
		            	//result[i]["id"] = partner[i].getId();
		            	//result[i]["linkMan"] = partner[i].getLinkMan();
		            	
		            	ulToShowHtml += "<li class=\"mui-table-view-cell\">";
		            	ulToShowHtml += "<a href=\""+partner[i].getId()+"\" al=\"";
		            	ulToShowHtml += partner[i].getLinkMan()+"\">"+partner[i].getLinkMan()+"</a></li>";
		            }
		            //ulToShow.innerHTML = ulToShowHtml;
		            
		            //console.log("result is "+JSON.stringify(result));
		            
		        }, function(message){
		        	mui.alert(message, '错误', function() {
					});
		        });
						
				
				main = plus.webview.currentWebview();
				//setTimeout的目的是等待窗体动画结束后，再执行create webview操作，避免资源竞争，导致窗口动画不流畅；
				setTimeout(function () {
					menu = mui.preload({
						id: 'partners-list',
						url: 'partners-list.html',
						styles: {
							left: "30%",
							width: '70%',
							zindex: 9997
						},
						extras:{
							// 传递从数据库中获取的伙伴值
							partnerHtml:ulToShowHtml
						}//自定义扩展参数
					});
				},300);
			});

			/*
			 * 显示菜单菜单
			 */
			function openMenu() {
					if (!showMenu) {
						//解决android 4.4以下版本webview移动时，导致fixed定位元素错乱的bug;
						if (mui.os.android && parseFloat(mui.os.version) < 4.4) {
							//document.querySelector("header.mui-bar").style.position = "static";
							//同时需要修改以下.mui-contnt的padding-top，否则会多出空白；
							//document.querySelector(".mui-bar-nav~.mui-content").style.paddingTop = "0px";
						}

						//侧滑菜单处于隐藏状态，则立即显示出来；
						//显示完毕后，根据不同动画效果移动窗体；
						menu.show('none', 0, function() {
							switch (mode){
								case 'main-move':
									//主窗体开始侧滑；
									main.setStyle({
										left: '-70%',
										transition: {
											duration: 150
										}
									});
									break;
								case 'menu-move':
									menu.setStyle({
										left: '30%',
										transition: {
											duration: 150
										}
									});
									break;
								case 'all-move':
									main.setStyle({
										left: '-70%',
										transition: {
											duration: 150
										}
									});
									menu.setStyle({
										left: '30%',
										transition: {
											duration: 150
										}
									});
									break;
							}
						});
						//显示主窗体遮罩
						mask.show();
						showMenu = true;
					}
				}
			function closeMenu () {
				//窗体移动
				_closeMenu();
				//关闭遮罩
				mask.close();
			}

			/**
			 * 关闭侧滑菜单(业务部分)
			 */
			function _closeMenu() {
				if (showMenu) {
					//解决android 4.4以下版本webview移动时，导致fixed定位元素错乱的bug;
					if (mui.os.android && parseFloat(mui.os.version) < 4.4) {
						//document.querySelector("header.mui-bar").style.position = "fixed";
						//同时需要修改以下.mui-contnt的padding-top，否则会多出空白；
						//document.querySelector(".mui-bar-nav~.mui-content").style.paddingTop = "44px";
					}

					switch (mode){
						case 'main-move':
							//主窗体开始侧滑；
							main.setStyle({
								left: '0',
								transition: {
									duration: 150
								}
							});
							break;
						case 'menu-move':
							//主窗体开始侧滑；
							menu.setStyle({
								left: '100%',
								transition: {
									duration: 150
								}
							});
							break;
						case 'all-move':
							//主窗体开始侧滑；
							main.setStyle({
								left: '0',
								transition: {
									duration: 150
								}
							});
							//menu页面同时移动
							menu.setStyle({
								left: '100%',
								transition: {
									duration: 150
								}
							});
							
							break;
					}
					//等窗体动画结束后，隐藏菜单webview，节省资源；
					setTimeout(function() {
						menu.hide();
					}, 300);
					showMenu = false;
				}
			}
			
			//变换侧滑动画移动效果；
			mui('.mui-input-group').on('change', 'input', function() {
				if (this.checked) {
					switch (this.value) {
						case 'main-move':
							//仅主窗口移动的时候，menu页面的zindex值要低一点；
							menu.setStyle({left:'30%',zindex:9997});
//							menu.hide();
							mode = 'main-move';
							break;
						case 'menu-move':
							menu.setStyle({left:'100%',zindex:9999});
							mode = 'menu-move';
							break;
						case 'all-move':
							//切换为整体移动
							//变换menu界面初始化位置，整体移动时，Menu界面left需要在-70%的地方；
							menu.setStyle({
								left: '100%'
							});
							mode = 'all-move';
							break;
					}
				}
			});
			
			
			document.getElementById("selectPartner").addEventListener('tap',openMenu);
			 //点击侧滑图标，打开侧滑菜单；
			document.querySelector('.mui-action-menu').addEventListener('tap', openMenu);
			 //在android4.4中的swipe事件，需要preventDefault一下，否则触发不正常
			 //故，在dragleft，dragright中preventDefault
			window.addEventListener('dragright', function(e) {
				e.detail.gesture.preventDefault();
			});
			window.addEventListener('dragleft', function(e) {
				e.detail.gesture.preventDefault();
			});
			 //主界面向左滑动，若菜单未显示，则显示菜单；否则不做任何操作；
			window.addEventListener("swipeleft", openMenu);
			 //主界面向右滑动，若菜单已显示，则关闭菜单；否则，不做任何操作；
			window.addEventListener("swiperight", closeMenu);
			 //menu页面向右滑动，关闭菜单；
			window.addEventListener("menu:swiperight", closeMenu);

			//添加newId自定义事件监听
			window.addEventListener('menu:newsId',function(event){
			  //获得事件参数
			  var id = event.detail.id;
			  var al = event.detail.al;
			  document.getElementById("selectPartner").innerText = al;
			  //根据id向服务器请求新闻详情
			  console.log("id is: "+id+" al is: "+al);
			});

			//添加newId自定义事件监听
			window.addEventListener('goodsSelListMsg',function(event){
			  //获得事件参数
			  
			  //根据id向服务器请求新闻详情
			  document.getElementById("addGoodsBtn").innerText = event.detail.msg;
			  console.log("msg is "+event.detail.msg);
			});
			
			 //重写mui.menu方法，Android版本menu按键按下可自动打开、关闭侧滑菜单；
			mui.menu = function() {
				if (showMenu) {
					closeMenu();
				} else {
					openMenu();
				}
			}
			
		document.getElementById("addGoodsBtn").addEventListener('tap', function() {
			
			var webview_style = {
				popGesture: "close"
			};
			//侧滑菜单需动态控制一下zindex值；
			/*if (~id.indexOf('offcanvas-')) {
				webview_style.zindex = 9998;
				webview_style.popGesture = ~id.indexOf('offcanvas-with-right') ? "close" : "none";
			}*/
		  	//打开添加商品页面
		  	mui.openWindow({
		    	url: 'goods_list_sel.html', 
		    	id:'goodsListSel',
		    	styles:webview_style,
		    	show: {
					aniShow: aniShow
				},
				waiting: {
					autoShow:true,//自动显示等待框，默认为true
					title:'正在加载...',//等待对话框上显示的提示内容
				}
		  	});
		});
		</script>

	<script>
		mui.init({
			swipeBack:true //启用右滑关闭功能
		});
	</script>
</html>