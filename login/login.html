<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <!--
    <script src="../js/pinyin/firstPinyin.js"></script>
    <script src="../js/pinyin/quanpin.js"></script>
   -->
    <script src="../js/mui.min.js"></script>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <script src="../js/Long.min.js"></script>
	<script src="../js/ByteBufferAB.min.js"></script>
	<script src="../js/ProtoBuf.noparse.min.js"></script>
	<script src="../js/Suowen.js"></script>
    <script type="text/javascript" charset="utf-8">
      	mui.init();
    </script>
    	<style>
			h5 {
				margin: 5px 7px;
			}
			
			.copyright2_line {
				  padding: 5% 5% 5% 5%;
				  width:100%;
				  position:fixed; _position:absolute;_bottom:expression(eval(document.body.scrollTop));z-index:1024;right:0;bottom:0; 
				}
		</style>
</head>

<body>
		<header class="mui-bar mui-bar-nav">
			<!--<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>-->
			<h1 class="mui-title">索问登陆</h1>
			<a id="info" class="mui-icon mui-icon-info-filled mui-pull-right" style="color: #999;"></a>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded" style="margin: 5px;">
				
				<form class="mui-input-group">
					<div class="mui-input-row">
						<input id="loginPhoneNum" class="mui-input-clear" type="text" placeholder="登陆手机号" value="111">
					</div>
					<div class="mui-input-row">
						<input id="loginPswd" type="password" class="mui-input-clear" placeholder="密码" value="111">
					</div>

					
					<div class="mui-button-row" style="height: auto;">
						<button id="loginBtn" type="button" style="width: 95%; height: auto;" class="mui-btn mui-btn-primary mui-btn-blue" onclick="return false;"><font size="4">登陆</font></button>
					</div>
					<br>
					<div align="center">
						<a id="loginProblem" ><font size="2">登陆遇到问题？</font></a>
					<div class="copyright2_line" align="center"><a id="register"><font size="2">注册</font></a></div>
						
					</div>
					
				</form>
				
			</div>
		</div>
</body>
<script>
	suowen.api.Init("http://suowen.tiger.mopaas.com");
    //添加协议文件
    suowen.api.AddProto("/sys/Login.json");
    //编译api成JS调用对象
    var root = suowen.api.Build();

    var loginRequest = new root.sys.LoginRequest ();
    
    var registerView;
    
	mui.plusReady(function(){
		
			console.log(plus.storage.getItem("token_val"));
			
			document.getElementById('loginBtn').addEventListener('tap',function(){
			var loginPhoneNum = document.getElementById('loginPhoneNum').value;
			var loginPswd = document.getElementById('loginPswd').value;
			
			var loginPhoneNumLen = document.getElementById('loginPhoneNum').value.length;
			var loginPswdLen = document.getElementById('loginPswd').value.length;
			var canLogin = false;
			
			if(0 == loginPhoneNumLen || 0 == loginPswdLen){
				mui.alert('登陆名和密码不能为空，请您重新输入', '错误', function() {
					document.getElementById('loginPhoneNum').focus();
				});
			}
			else
				canLogin = true;
				
			if(canLogin){
		        //loginRequest.setFields("id,name");
				loginRequest.setLogin(loginPhoneNum);
				loginRequest.setPassword(loginPswd);
		        //执行API操作,TODO 结合MUI自动出现loading效果
		        
		        // 所有页面的fetch之前都要加上以下这句话，这个token值需要存起来。保存在本地。vvvv
		        //suowen.api.token = "";
		        // 所有页面的fetch之前都要加上以下这句话，这个token值需要存起来。保存在本地。^^^^
		        
		        suowen.api.Fetch(loginRequest,
		        	function(response){
		        		//var data = response.getData()
		        		var copName = response.getCorporateName();
		        		var tokenVal = response.getToken();
		        		mui.alert("登陆成功,公司名称为："+copName+
		        		"\ntoken为："+tokenVal, '成功', function() {
		        			mui.openWindow({
								id: "indexSuowen",
								url: "../indexSuowen.html"
							});
						});
						// 将token的值存储在plus.storage中，随时可以取出。
						plus.storage.setItem("token_val", tokenVal);						
		        	},
		        	function(message){
		        		mui.alert(message, '返回错误', function() {
						});
		        	});
			}
			
			/*console.log("单击loginBtn");
			console.log("login phone num is "+loginPhoneNum);
			console.log("login pswd is "+loginPswd);*/
		});
		
		//registerView = plus.webview.create("register.html");
	});
	
	

	document.getElementById('loginProblem').addEventListener('tap', function() {
	  	//打开注册遇到问题页面
	  	mui.openWindow({
	    	url: 'loginProblem.html', 
	    	id:'loginProblem',
	    	extras:{
	    		name:'mui',
	        	version:'0.5.8'
	    	}
	  	});
	});

	document.getElementById('register').addEventListener('tap', function() {
		//console.log('click the register');
	  	//打开注册遇到问题页面
	  	//registerView.show("slide-in-right",150);
	  	
	  	//console.log('show the register');
	  	mui.openWindow({
	    	url: 'register.html', 
	    	id:'register',
	    	waiting:{
				autoShow:true,//自动显示等待框，默认为true
				title:'正在加载...',//等待对话框上显示的提示内容
			}
	  	});
	  	
	});

	

//////////////////拼音全拼，和拼音首字母的调用方法/////////////////////
/*
var arrRslt = makePy("漫漫屋飘逸杯泡茶杯马杰楼房刘哥阿付");
console.log(arrRslt);
console.log(codefans_net_CC2PY("漫漫屋飘逸杯泡茶杯马杰楼房刘哥阿付"));
*/
//////////////////拼音全拼，和拼音首字母的调用方法/////////////////////
//首页返回键处理
		//处理逻辑：1秒内，连续两次按返回键，则退出应用；
		var showMenu = false;
		var first = null;
		mui.back = function() {
			if (showMenu) {
				closeMenu();
			} else {
				//首次按键，提示‘再按一次退出应用’
				if (!first) {
					first = new Date().getTime();
					mui.toast('再按一次退出索问');
					setTimeout(function() {
						first = null;
					}, 1000);
				} else {
					if (new Date().getTime() - first < 1000) {
						plus.runtime.quit();
					}
				}
			}
		};
</script>
</html>