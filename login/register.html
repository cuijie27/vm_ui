<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="../js/mui.min.js"></script>
    <script src="../js/Long.min.js"></script>
	<script src="../js/ByteBufferAB.min.js"></script>
	<script src="../js/ProtoBuf.noparse.min.js"></script>
	<script src="../js/Suowen.js"></script>
	<script src="../js/mui.poppicker.js"></script>
	<script src="../js/mui.listpicker.js"></script>
    <script src="../js/jquery-2.1.0.js"></script>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    
    <!--App自定义的css-->
	<link href="../css/mui.listpicker.css" rel="stylesheet" />
	<link href="../css/mui.poppicker.css" rel="stylesheet" />
	<style>
		.mui-btn {
			font-size: 16px;
		}
		h5.mui-content-padded {
			margin-left: 3px;
			margin-top: 20px !important;
		}
		h5.mui-content-padded:first-child {
			margin-top: 12px !important;
		}
		.ui-alert {
			text-align: center;
			padding: 20px 10px;
			font-size: 16px;
		}
	</style>
    <script type="text/javascript" charset="utf-8">
      	mui.init();
    </script>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">用户注册</h1>
	</header>

	<div class="mui-content">
		<div class="mui-content-padded" style="margin: 5px;">
			<h5>联系电话&登陆名称<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
				<input id="cellphoneNum" class="mui-input-clear" type="text" placeholder="联系电话&登陆名称">
			</div>
			<h5>登陆密码<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
				<input id="loginPswd" class="mui-input-clear" type="password" placeholder="登陆密码">
			</div>
			<h5>确认登陆密码<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
				<input id="pswdConfirm" class="mui-input-clear" type="password" placeholder="确认登陆密码">
			</div>
			<h5>企业名称（或别名）<font color="#FF0000" size="4">*</font>：</h5>
			<div class="mui-input-row">
				<input id="companyName" class="mui-input-clear" type="text" placeholder="企业名称">
			</div>
			<h5>渠道主营<font color="#FF0000" size="4">*</font>：</h5>
			<button id='showChannelPicker' class="mui-btn " style="width: 100%;" type='button'>选择所属渠道 ...</button>
			<!--<div id='channelResult' class="ui-alert"></div>-->
			<h5>负责人：</h5>
			<div class="mui-input-row">
				<input id="personInCharge" class="mui-input-clear" type="text" placeholder="负责人">
			</div>
			<button id="registerBtn" type="button" style="width: 100%; height: auto;" class="mui-btn mui-btn-primary mui-btn-blue" onclick="return false;"><font size="">注册</font></button>
		</div>
	</div>
	
	<script>
		
	
		function plusReady(){
			
		console.log("in page get token val is "+plus.storage.getItem("token_val"));
		//var dataStr = "in plus ready [";
        //初始化API
        suowen.api.Init("http://suowen.tiger.mopaas.com");
        //添加协议文件
        suowen.api.AddProto("/sys/DicQuery.json");
        suowen.api.AddProto("/sys/Registry.json");
        //编译api成JS调用对象
        var root = suowen.api.Build();

        var dicQueryRequest = new root.sys.DicQueryRequest()
        var registerRequest = new root.sys.RegistryRequest()
        dicQueryRequest.setDic(root.sys.Dic.INDUSTRY);
        dicQueryRequest.setFields("id,name");

        //执行API操作,TODO 结合MUI自动出现loading效果
        suowen.api.Fetch(dicQueryRequest,function(response){
            var data = response.getData();
        	/////////////////生成jsonArray/////////////////
        	var result = [];
        	for(var i=0;i<data.length;i++){
        		var e = data[i].getObject();
        		result[i] = {};
                for(var j=0;j<e.length;j++){
                	if (j==0)
                		result[i]["value"] = e[j].getValue();
                	else
                		result[i]["text"] =  e[j].getValue();
                }
              }
        	console.log("result is "+JSON.stringify(result));
        	//console.log("test info");
        	//////////////////////////////////
        	
        		
        		/////////////////////弹出菜单代码////////////////////
		        (function($, doc) {
				$.init();
				$.ready(function() {
					//普通示例
					var userPicker = new $.PopPicker();
					userPicker.setData(result);
					var showChannelPicker = doc.getElementById('showChannelPicker');
					//var channelResult = doc.getElementById('channelResult');
					showChannelPicker.addEventListener('tap', function(event) {
						userPicker.show(function(items) {
							//channelResult.innerText = JSON.stringify(items[0]);
							//jquery 冲突的解决办法 
							jQuery.noConflict();
 							(function( $ ) {
							    // Your jQuery code here, using the $
							    //获取渠道名称和id值
							    $("#showChannelPicker").text(items[0]["text"]);
							    $("#showChannelPicker").data("industryId", items[0]["value"]);
							})( jQuery );
							//jquery 冲突的解决办法 
						});
					}, false); 
					
					///////////////////注册按钮////////////////////
					var registerBtn = doc.getElementById('registerBtn');
					registerBtn.addEventListener('tap', function(event) {
							var companyNameStr = "", companyNameLen = 0;
							var loginName = "", loginNameLen = 0;
							var loginPswd = "", loginPswdLen = 0;
							var pswdConfirm = "", pswdConfirmLen = 0;
							var industryId = 0, industryIdLen = 0;
							var canInsert = false, allInputed = false, pswdIsEqual = false;
							//jquery 冲突的解决办法 
							jQuery.noConflict();
 							(function( $ ) {
							    // Your jQuery code here, using the $
							    //获取渠道名称和id值
							    companyNameStr = $("#companyName").val();
							    companyNameLen = $.trim($("#companyName").val()).length;
							    
							    loginName = $("#cellphoneNum").val();
							    loginNameLen = $.trim($("#cellphoneNum").val()).length;
							    
							    loginPswd = $("#loginPswd").val();
							    loginPswdLen = $.trim($("#loginPswd").val()).length;
							    
							    pswdConfirm = $("#pswdConfirm").val();
							    pswdConfirmLen = $.trim($("#pswdConfirm").val()).length;
							    
							    industryId = $("#showChannelPicker").data("industryId");
							    industryIdLen = $.trim($("#showChannelPicker").data("industryId")).length;
							    
							    if(loginNameLen < 1 || loginPswdLen < 1 || 
							    	pswdConfirmLen < 1 || companyNameLen < 1 || 
							    	industryIdLen < 1){
									mui.alert('红色星号项为必填项，请将注册信息填写完整', '信息漏填', function() {
										//info.innerText = '你刚关闭了警告框';
									});
								}
							    else{
							    	allInputed = true;
							    }
							    
							    // 只弹一次框
							    if(($.trim($("#loginPswd").val()) != $.trim($("#pswdConfirm").val())) && allInputed){
							    	mui.alert('两次密码输入不一致，请重新输入', '密码不一样', function() {
										//info.innerText = '你刚关闭了警告框';
										$("#loginPswd").val("");
										$("#pswdConfirm").val("");
										$("#loginPswd").focus();
									});
							    }
							    else{
							    	pswdIsEqual = true;
							    }
							    if(allInputed && pswdIsEqual){
							    		canInsert = true;
							    	}
							})( jQuery );
							//jquery 冲突的解决办法 
							
							if (canInsert){
								//////////////////////询问对话框///////////////////////////////////
								var btnArray = ['是', '否'];
								mui.confirm("企业名称： "+companyNameStr+
								"\n登陆名称："+loginName, '注册信息确认', btnArray, function(e) {
									// 选择是
									if (e.index == 0) {
										//info.innerText = '你刚确认MUI是个好框架';
										registerRequest.setLogin(loginName);
										registerRequest.setPassword(loginPswd);
										registerRequest.setCorporateName(companyNameStr);
										registerRequest.setIndustry(parseInt(industryId));	// 需要转换为int型才能成功insert记录
								        //执行API操作,TODO 结合MUI自动出现loading效果
								        suowen.api.Fetch(registerRequest,function(response){
								        	//console.log(response);
								        	mui.alert('恭喜您，注册成功！', '成功', function() {
												
											});
								        },function(message){
								            alert(message);
								        });
									} 
									// 选择否
									else {
										//info.innerText = 'MUI没有得到你的认可，继续加油'
									}
								});
								//////////////////////询问对话框///////////////////////////////////
							}
							
							
					}, false); 
					///////////////////注册按钮////////////////////
				});
			})(mui, document);
			/////////////////////弹出菜单代码////////////////////
	
        },function(message){
            alert(message);
        });
     };

	if(window.plus){
		plusReady();
	}else{
		document.addEventListener("plusready",plusReady,false);
	}	

		</script>
</body>
</html>